#cloud-config
package_update: true
package_upgrade: true

packages:
  - git
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - certbot

runcmd:
  # Docker GPG Key und Repo
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  
  # Installation von Docker und Compose V2
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Repo klonen
  - rm -rf /opt/app
  - git clone https://github.com/Theodor-v-B/Herz_Seele.git /opt/app

  # Erst HTTP-only NGINX config aktivieren (damit Container nicht crasht)
  - cp /opt/app/frontend/nginx-http.conf /opt/app/frontend/nginx.conf

  # .env anlegen
  - |
    cat <<EOF > /opt/app/.env
    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=password123
    POSTGRES_DB=anlaufstellen
    PGHOST=postgres
    PGUSER=postgres
    PGPASSWORD=password123
    PGDATABASE=anlaufstellen
    PGPORT=http://backend:3000
    EOF

  # Container starten
  - cd /opt/app && docker compose up -d --build

  # Zertifikat holen (mit Retry)
  - |
    DOMAIN="schrittnachvorn.de"
    for i in 1 2 3 4 5; do
      certbot certonly --webroot \
        -w /opt/app/certbot/www \
        -d "$DOMAIN" \
        -d "www.$DOMAIN" \
        --agree-tos \
        -m "admin@$DOMAIN" \
        --non-interactive && break
      sleep 15
    done

  # HTTPS config aktivieren und frontend neu starten
  - cp /opt/app/frontend/nginx-https.conf /opt/app/frontend/nginx.conf
  - cd /opt/app && docker compose up -d --build

  # Frontend/NGINX neu starten, damit er die Zertifikate laden kann
  # Er mountet den Ordner /cert/www in den Container
  - cd /opt/app && docker compose restart frontend || true
  